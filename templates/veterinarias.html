{% extends 'partials/base.html' %}
{% load static %}


{% block css %}

<link href="{% static 'plugins/datatable/css/dataTables.bootstrap4.min.css' %}" rel="stylesheet" type="text/css">
<link href="{% static 'plugins/datatable/css/buttons.bootstrap4.min.css' %}" rel="stylesheet" type="text/css">


{% endblock css %}
{% block content %}

<div id="app">
    <div class="row">
        <div class="col-12 col-lg-8 col-md-12">
            <div id="map" style="height: 550px; width: 750px;"></div>
        </div>
        <div class="col-12 col-lg-4 col-md-12">
            <div class="card radius-15 bg-login-color" v-for="veterinaria in veterinarias" :key="veterinaria.place_id">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2">
                        <div class="">
                            <h5 class="mb-0">[[ veterinaria.name ]]</h5>
                            <p>Calificación: [[ veterinaria.rating ]]</p>
                            <p>Dirección: [[ veterinaria.formatted_address ]]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock content %}


{% block js %}

<script>
    var map;

    function initMap() {
        // Create a new map without a center
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12, // Default zoom
            // You can set a default center if you like
        });

        // Try to use geolocation
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                // Success callback
                var userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Set the center of the map to the user's location and add a marker
                map.setCenter(userLocation);
                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'Your Location'
                });

            }, function () {
                // Error callback
                handleLocationError(true);
            });
        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false);
        }
    }

    function handleLocationError(browserHasGeolocation) {
        // If geolocation is not supported or failed, you can handle it here
        alert(browserHasGeolocation ?
            'Geolocation service failed.' :
            'Your browser doesn\'t support geolocation.');

        // Optionally set a default center if geolocation fails
        if (!map.getCenter()) {
            var defaultLocation = { lat: -34.397, lng: 150.644 }; // Replace with any default location
            map.setCenter(defaultLocation);
            new google.maps.Marker({
                position: defaultLocation,
                map: map,
                title: 'Default Location'
            });
        }
    }
</script>

<script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            ubicacionUsuario: null,
            veterinarias: [],
        },
        created() {
            this.obtenerUbicacionUsuario();
        },
        methods: {
            obtenerUbicacionUsuario() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(this.obtenerVeterinariasCercanas);
                } else {
                    alert("La geolocalización no es soportada por este navegador.");
                }
            },
            obtenerVeterinariasCercanas(position) {
                this.ubicacionUsuario = position.coords;
                axios.get(`/api/veterinarias-cercanas/?lat=${this.ubicacionUsuario.latitude}&lng=${this.ubicacionUsuario.longitude}`)
                    .then(response => {
                        // Filtra aquellos elementos que tienen una propiedad 'result' y un 'rating'
                        const lugaresConResultados = response.data
                            .filter(item => item.result && item.result.rating)
                            .map(item => item.result);

                        // Ordena los lugares por rating de mayor a menor
                        lugaresConResultados.sort((a, b) => b.rating - a.rating);

                        // Toma los primeros 3 lugares después de ordenarlos
                        this.veterinarias = lugaresConResultados.slice(0, 3);
                        console.log(this.veterinarias);
                    })
                    .catch(error => {
                        console.error("Error al obtener las veterinarias cercanas:", error);
                    });
            }
        }
    });

</script>

{% endblock js %}